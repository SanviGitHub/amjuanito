<!DOCTYPE html>
<html lang="es" class="h-full bg-white scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automotores Juanito</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font (Inter) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Lucide Icons (CORREGIDO: Se quitó "-react" de la URL) -->
    <!-- <script src="https://unpkg.com/lucide@latest/dist/lucide.min.js"></script> --> <!-- ELIMINADO DE AQUÍ -->
    <!-- (NUEVO) Animate.css - Biblioteca Extra -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        /* --- NUEVO TEMA: MINIMALISTA "FINO" + ROJO ACENTO --- */
        :root {
            --aj-dark: #111827; /* gray-900 */
            --aj-text: #374151; /* gray-700 */
            --aj-text-light: #6B7280; /* gray-500 */
            --aj-gray-light: #F3F4F6; /* gray-100 */
            --aj-white: #FFFFFF;
            --aj-brand: #DC2626; /* red-600 */
            --aj-brand-dark: #B91C1C; /* red-700 */
        }
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            line-height: 1.6;
            background-color: var(--aj-white);
            color: var(--aj-text);
        }
        /* Custom scrollbar (Estilo Fino) */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--aj-gray-light);
        }
        ::-webkit-scrollbar-thumb {
            background-color: #BCBCC1;
            border-radius: 20px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #9A9A9F;
        }

        /* Ocultar flechas en input[type=number] */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* Ocultar scrollbar de modal */
        #car-form-modal::-webkit-scrollbar,
        #delete-modal::-webkit-scrollbar,
        #detalle-auto-modal::-webkit-scrollbar {
            display: none;
        }
        #car-form-modal,
        #delete-modal,
        #detalle-auto-modal {
            -ms-overflow-style: none;  /* IE y Edge */
            scrollbar-width: none;  /* Firefox */
        }

        /* --- ANIMACIONES (Animate.css) --- */
        
        /* Ocultar elementos para animación */
        .animate-on-scroll {
            opacity: 0; /* Oculto hasta que el observer actúe */
        }

        /* Animación de pulso para botón de WhatsApp */
        @keyframes pulse-wpp {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            50% { transform: scale(1.05); box-shadow: 0 0 0 12px rgba(34, 197, 94, 0); }
        }
        .btn-pulse-wpp {
            animation: pulse-wpp 2s infinite;
        }
    </style>
</head>
<body class="h-full">

    <!-- Loader de App -->
    <div id="app-loader" class="fixed inset-0 bg-aj-white flex flex-col items-center justify-center z-[100]">
        <!-- (NUEVO) Logo con bordes redondeados -->
        <img src="https://i.postimg.cc/XqLD6P0p/wmremove-transformed-1.png" alt="Logo Automotores Juanito" class="w-64 h-auto animate-pulse rounded-md">
        <p id="app-loader-text" class="text-aj-text-light mt-4">Cargando plataforma...</p>
    </div>

    <!-- Contenido Principal -->
    <div id="app-content" class="min-h-full flex flex-col hidden">
        
        <!-- Header (NUEVO ESTILO "APPLE") -->
        <header class="bg-aj-white/80 backdrop-blur-lg sticky top-0 z-30 shadow-sm border-b border-gray-200">
            <nav class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-20">
                    <!-- Logo (NUEVO) Bordes redondeados -->
                    <a href="#home" class="flex-shrink-0 flex items-center gap-2">
                        <img src="https://i.postimg.cc/XqLD6P0p/wmremove-transformed-1.png" alt="Logo Automotores Juanito" class="w-48 h-auto rounded-md">
                    </a>
                    <!-- Navegación Pública (Estilo Claro) -->
                    <div class="hidden sm:flex sm:space-x-8">
                        <a href="#home" class="nav-link border-b-2 border-aj-brand text-aj-dark inline-flex items-center px-1 pt-1 font-semibold">Inicio</a>
                        <a href="#ultimos-ingresos-section" class="nav-link border-b-2 border-transparent text-aj-text-light hover:border-aj-brand hover:text-aj-dark inline-flex items-center px-1 pt-1 font-semibold">Destacados</a>
                        <a href="#catalogo-section" class="nav-link border-b-2 border-transparent text-aj-text-light hover:border-aj-brand hover:text-aj-dark inline-flex items-center px-1 pt-1 font-semibold">Catálogo</a>
                        <a href="#contacto-section" class="nav-link border-b-2 border-transparent text-aj-text-light hover:border-aj-brand hover:text-aj-dark inline-flex items-center px-1 pt-1 font-semibold">Contacto</a>
                        <a href="#admin" class="nav-link border-b-2 border-transparent text-aj-text-light hover:border-aj-brand hover:text-aj-dark inline-flex items-center px-1 pt-1 font-semibold">
                            <i data-lucide="lock" class="w-4 h-4 mr-2"></i>Admin
                        </a>
                    </div>
                    <!-- Botón Mobile -->
                    <div class="sm:hidden">
                        <button id="mobile-menu-btn" class="inline-flex items-center justify-center p-2 rounded-lg text-aj-text-light hover:text-aj-dark hover:bg-aj-gray-light focus:outline-none focus:ring-2 focus:ring-inset focus:ring-aj-brand">
                            <i data-lucide="menu" class="block h-6 w-6"></i>
                        </button>
                    </div>
                </div>
            </nav>
            <!-- Menú Mobile (Estilo Claro) -->
            <div id="mobile-menu" class="hidden sm:hidden bg-aj-white shadow-lg">
                <div class="pt-2 pb-4 space-y-1">
                    <a href="#home" class="nav-link block pl-3 pr-4 py-2 border-l-4 border-aj-brand text-aj-dark font-semibold">Inicio</a>
                    <a href="#ultimos-ingresos-section" class="nav-link block pl-3 pr-4 py-2 border-l-4 border-transparent text-aj-text-light font-semibold">Destacados</a>
                    <a href="#catalogo-section" class="nav-link block pl-3 pr-4 py-2 border-l-4 border-transparent text-aj-text-light font-semibold">Catálogo</a>
                    <a href="#contacto-section" class="nav-link block pl-3 pr-4 py-2 border-l-4 border-transparent text-aj-text-light font-semibold">Contacto</a>
                    <a href="#admin" class="nav-link block pl-3 pr-4 py-2 border-l-4 border-transparent text-aj-text-light font-semibold">
                        <i data-lucide="lock" class="w-4 h-4 mr-2 inline-block"></i>Admin
                    </a>
                </div>
            </div>
        </header>

        <!-- Contenedor de Páginas -->
        <main class="flex-grow">
            <!-- Página: Inicio (Home) - AHORA CONTIENE TODO -->
            <section id="page-home" class="page-section">
                
                <!-- Hero Section (NUEVO ESTILO CLARO) -->
                <div id="home" class="bg-aj-white text-aj-dark overflow-hidden animate-on-scroll">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-24 md:py-40 text-center">
                        <img src="https://i.postimg.cc/XqLD6P0p/wmremove-transformed-1.png" alt="Logo Automotores Juanito" class="w-full max-w-xl mx-auto h-auto mb-6 animate__animated animate__fadeInDown">
                        <h1 class="text-4xl md:text-6xl font-extrabold tracking-tight mb-4 animate__animated animate__fadeInDown" style="animation-delay: 0.2s;">Tu próximo auto está acá.</h1>
                        <p class="text-xl md:text-2xl text-aj-text-light max-w-2xl mx-auto mb-10 animate__animated animate__fadeInDown" style="animation-delay: 0.4s;">Más de 20 años de confianza en Jose C Paz.</p>
                        <!-- NUEVO BOTÓN "FINO" (OUTLINE) -->
                        <a href="#catalogo-section" class="border-2 border-aj-brand text-aj-brand px-8 py-4 rounded-lg font-bold shadow-sm transition-all duration-300 ease-in-out hover:bg-aj-brand hover:text-white focus:outline-none focus:ring-2 focus:ring-aj-brand focus:ring-offset-2 transform hover:-translate-y-0.5 text-lg inline-flex items-center justify-center animate__animated animate__fadeInUp" style="animation-delay: 0.6s;">
                            <i data-lucide="search" class="w-5 h-5 mr-3"></i>Ver Catálogo Completo
                        </a>
                    </div>
                </div>

                <!-- Sección Por Qué Elegirnos (Estilo Fino) -->
                <section id="por-que-elegirnos" class="bg-aj-gray-light py-16 sm:py-24 animate-on-scroll">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="text-center mb-16">
                            <h2 class="text-3xl font-extrabold text-aj-dark sm:text-4xl">La confianza que buscás.</h2>
                            <p class="mt-4 text-xl text-aj-text-light">Te acompañamos en cada paso.</p>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
                            <!-- Feature 1 -->
                            <div class="text-center animate-on-scroll">
                                <div class="flex items-center justify-center h-16 w-16 rounded-full bg-red-100 text-aj-brand mx-auto mb-5">
                                    <i data-lucide="shield-check" class="w-8 h-8"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-aj-dark mb-2">Usados Seleccionados</h3>
                                <p class="text-aj-text-light">Todas nuestras unidades pasan por un riguroso chequeo mecánico para tu tranquilidad.</p>
                            </div>
                            <!-- Feature 2 -->
                            <div class="text-center animate-on-scroll" style="animation-delay: 0.2s;">
                                <div class="flex items-center justify-center h-16 w-16 rounded-full bg-red-100 text-aj-brand mx-auto mb-5">
                                    <i data-lucide="banknote" class="w-8 h-8"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-aj-dark mb-2">Financiación a Medida</h3>
                                <p class="text-aj-text-light">Entregá tu usado o un anticipo y financiá el resto en cuotas fijas y en pesos.</p>
                            </div>
                            <!-- Feature 3 -->
                            <div class="text-center animate-on-scroll" style="animation-delay: 0.4s;">
                                <div class="flex items-center justify-center h-16 w-16 rounded-full bg-red-100 text-aj-brand mx-auto mb-5">
                                    <i data-lucide="file-text" class="w-8 h-8"></i>
                                </div>
                                <h3 class="text-2xl font-bold text-aj-dark mb-2">Gestoría Propia</h3>
                                <p class="text-aj-text-light">Nos encargamos de todo el papelerío. Te llevás el auto transferido y sin deudas.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Sección Destacados (Estilo Fino) -->
                <section id="ultimos-ingresos-section" class="bg-aj-white py-16 sm:py-24 animate-on-scroll">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <h2 class="text-3xl font-extrabold text-aj-dark text-center mb-12">Últimos Ingresos</h2>
                        <div id="home-destacados-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            <!-- JS Rellena esto -->
                        </div>
                        <div id="home-destacados-loader" class="text-center">
                            <p class="text-aj-text-light">Cargando destacados...</p>
                        </div>
                    </div>
                </section>

                <!-- Sección Catálogo (Estilo Fino) - ¡ESTA SECCIÓN YA ESTABA! -->
                <section id="catalogo-section" class="page-section bg-aj-gray-light py-16 sm:py-24 animate-on-scroll">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <h2 class="text-4xl font-extrabold text-aj-dark text-center mb-12">Nuestro Catálogo</h2>
                        
                        <!-- Filtros (Estilo Fino) -->
                        <div class="bg-aj-white p-6 rounded-lg shadow-sm mb-12">
                            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                                <!-- Filtro Marca -->
                                <div>
                                    <label for="filter-marca" class="block text-sm font-semibold text-gray-700 mb-1">Marca</label>
                                    <select id="filter-marca" class="block w-full p-3 border border-gray-300 rounded-lg shadow-sm text-lg focus:outline-none focus:ring-2 focus:ring-aj-brand focus:border-transparent text-base">
                                        <option value="">Todas las Marcas</option>
                                        <!-- JS Rellena esto -->
                                    </select>
                                </div>
                                <!-- Filtro Precio -->
                                <div>
                                    <label for="filter-precio" class="block text-sm font-semibold text-gray-700 mb-1">Precio (Máx)</label>
                                    <select id="filter-precio" class="block w-full p-3 border border-gray-300 rounded-lg shadow-sm text-lg focus:outline-none focus:ring-2 focus:ring-aj-brand focus:border-transparent text-base">
                                        <option value="">Cualquier Precio</option>
                                        <option value="5000000">$5.000.000</option>
                                        <option value="10000000">$10.000.000</option>
                                        <option value="15000000">$15.000.000</option>
                                        <option value="20000000">$20.000.000</option>
                                        <option value="30000000">$30.000.000</option>
                                    </select>
                                </div>
                                <!-- Filtro Año -->
                                <div>
                                    <label for="filter-ano" class="block text-sm font-semibold text-gray-700 mb-1">Año (Mín)</label>
                                    <select id="filter-ano" class="block w-full p-3 border border-gray-300 rounded-lg shadow-sm text-lg focus:outline-none focus:ring-2 focus:ring-aj-brand focus:border-transparent text-base">
                                        <option value="">Cualquier Año</option>
                                        <option value="2024">2024</option>
                                        <option value="2022">2022</option>
                                        <option value="2020">2020</option>
                                        <option value="2018">2018</option>
                                        <option value="2015">2015</option>
                                        <option value="2010">2010</option>
                                    </select>
                                </div>
                                <!-- Ordenar -->
                                <div>
                                    <label for="filter-sort" class="block text-sm font-semibold text-gray-700 mb-1">Ordenar Por</label>
                                    <select id="filter-sort" class="block w-full p-3 border border-gray-300 rounded-lg shadow-sm text-lg focus:outline-none focus:ring-2 focus:ring-aj-brand focus:border-transparent text-base">
                                        <option value="recientes">Más Recientes</option>
                                        <option value="precio-asc">Precio (Menor a Mayor)</option>
                                        <option value="precio-desc">Precio (Mayor a Menor)</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Grid de Autos -->
                        <div id="catalogo-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                            <!-- JS Rellena esto -->
                        </div>
                        <div id="catalogo-loader" class="text-center py-12">
                            <p class="text-aj-text-light text-lg">Cargando vehículos...</p>
                        </div>
                        <div id="catalogo-no-results" class="hidden text-center py-12">
                            <i data-lucide="search-x" class="w-16 h-16 mx-auto text-gray-400"></i>
                            <p class="text-aj-text-light text-xl mt-4">No se encontraron vehículos.</p>
                            <p class="text-aj-text-light">Intentá cambiar los filtros de búsqueda.</p>
                        </div>

                    </div>
                </section>

                <!-- (REWORK) CÓMO COMPRAR -->
                <section id="como-comprar" class="bg-aj-white py-16 sm:py-24 animate-on-scroll">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div class="text-center mb-16">
                            <h2 class="text-3xl font-extrabold text-aj-dark sm:text-4xl">Comprar tu auto es simple.</h2>
                            <p class="mt-4 text-xl text-aj-text-light">En 3 simples pasos, te subís al auto de tus sueños.</p>
                        </div>
                        
                        <!-- Pasos (Nuevo diseño) -->
                        <div class="relative">
                            <!-- Línea punteada (solo en desktop) -->
                            <div class="hidden md:block absolute top-1/2 left-0 right-0 h-0.5 bg-gray-200" style="transform: translateY(-2rem);"></div>
                            
                            <div class="relative grid grid-cols-1 md:grid-cols-3 gap-10">
                                <!-- Paso 1 -->
                                <div class="relative p-6 bg-aj-gray-light rounded-lg shadow-sm animate-on-scroll">
                                    <div class="absolute -top-5 -left-5 w-16 h-16 flex items-center justify-center rounded-full bg-aj-brand text-white font-extrabold text-2xl shadow-lg">01</div>
                                    <h3 class="text-2xl font-bold text-aj-dark mb-2 mt-8">Mirá el Catálogo</h3>
                                    <p class="text-aj-text-light">Explorá todos nuestros vehículos disponibles y filtrá por marca, precio o año.</p>
                                </div>
                                <!-- Paso 2 -->
                                <div class="relative p-6 bg-aj-gray-light rounded-lg shadow-sm animate-on-scroll" style="animation-delay: 0.2s;">
                                    <div class="absolute -top-5 -left-5 w-16 h-16 flex items-center justify-center rounded-full bg-aj-brand text-white font-extrabold text-2xl shadow-lg">02</div>
                                    <h3 class="text-2xl font-bold text-aj-dark mb-2 mt-8">Contactanos</h3>
                                    <p class="text-aj-text-light">Mandanos un WhatsApp o llamanos para coordinar una visita y probar el auto.</p>
                                </div>
                                <!-- Paso 3 -->
                                <div class="relative p-6 bg-aj-gray-light rounded-lg shadow-sm animate-on-scroll" style="animation-delay: 0.4s;">
                                    <div class="absolute -top-5 -left-5 w-16 h-16 flex items-center justify-center rounded-full bg-aj-brand text-white font-extrabold text-2xl shadow-lg">03</div>
                                    <h3 class="text-2xl font-bold text-aj-dark mb-2 mt-8">Retiralo en el Día</h3>
                                    <p class="text-aj-text-light">Arreglamos los papeles y te vas manejando. ¡Así de fácil!</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>


                <!-- Página: Contacto (Estilo Fino) -->
                <section id="contacto-section" class="page-section bg-aj-gray-light py-16 sm:py-24 animate-on-scroll">
                    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <h2 class="text-4xl font-extrabold text-aj-dark text-center mb-12">Vení a visitarnos</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-12">
                            <!-- Info de Contacto -->
                            <div class="bg-aj-white p-8 rounded-lg shadow-xl">
                                <h3 class="text-2xl font-bold text-aj-dark mb-6">Hablá con nosotros</h3>
                                <div class="space-y-5">
                                    <!-- Teléfono/Wpp -->
                                    <div class="flex items-center gap-4">
                                        <div class="bg-green-100 p-3 rounded-full">
                                            <i data-lucide="message-circle" class="w-6 h-6 text-green-600"></i>
                                        </div>
                                        <div>
                                            <span class="block text-sm font-semibold text-aj-text-light">WhatsApp</span>
                                            <a id="contact-wpp-link" href="#" target="_blank" class="text-lg font-bold text-green-600 hover:underline">
                                                <span id="contact-wpp-text">Cargando...</span>
                                            </a>
                                        </div>
                                    </div>
                                    <!-- Ubicación -->
                                    <div class="flex items-center gap-4">
                                        <div class="bg-blue-100 p-3 rounded-full">
                                            <i data-lucide="map-pin" class="w-6 h-6 text-blue-600"></i>
                                        </div>
                                        <div>
                                            <span class="block text-sm font-semibold text-aj-text-light">Dirección</span>
                                            <a id="contact-map-link" href="#" target="_blank" class="text-lg font-bold text-aj-dark hover:underline">
                                                <span id="contact-map-text">D Elia Maestro 4969, José C. Paz</span>
                                            </a>
                                        </div>
                                    </div>
                                    <!-- Horario -->
                                    <div class="flex items-center gap-4">
                                        <div class="bg-yellow-100 p-3 rounded-full">
                                            <i data-lucide="clock" class="w-6 h-6 text-yellow-600"></i>
                                        </div>
                                        <div>
                                            <span class="block text-sm font-semibold text-aj-text-light">Horarios</span>
                                            <span id="contact-hours-text" class="text-lg font-bold text-aj-dark">Lunes a Sábado: 9 a.m. – 7:15 p.m.</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <!-- Mapa -->
                            <div class="bg-gray-300 rounded-lg shadow-xl overflow-hidden h-64 md:h-full">
                                <iframe id="contact-map-iframe" class="w-full h-full"
                                    src="https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3287.619089201919!2d-58.70588102377481!3d-34.51261175373656!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x95bcbd0643b17c75%3A0x633d07d4e46358c!2sD'El%C3%ADa%2C+Maestro+4969%2C+B1665+Jos%C3%A9+C.+Paz%2C+Provincia+de+Buenos+Aires!5e0!3m2!1ses-419!2sar!4v1731037415442!5m2!1ses-419!2sar"
                                    style="border:0;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade">
                                </iframe>
                            </div>
                        </div>
                    </div>
                </section>
            </section>

            <!-- Página: Detalle de Auto (Modal) (Estilo Fino) -->
            <div id="detalle-auto-modal" class="fixed inset-0 z-40 bg-black/80 backdrop-blur-sm hidden items-start justify-center p-4 overflow-y-auto">
                <div class="bg-aj-white w-full max-w-4xl rounded-lg shadow-2xl my-10 relative animate__animated animate__fadeInDown" style="animation-duration: 0.5s;">
                    <!-- Botón Cerrar -->
                    <button id="detalle-auto-close-btn" class="absolute -top-3 -right-3 z-10 bg-aj-dark text-aj-white rounded-full p-2 shadow-lg hover:bg-gray-700 transition-transform hover:scale-110">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                    <!-- Contenido del Modal -->
                    <div id="detalle-auto-content" class="overflow-hidden rounded-lg">
                        <!-- Loader -->
                        <div id="detalle-auto-loader" class="p-12 text-center">
                            <p class="text-aj-text-light">Cargando auto...</p>
                        </div>
                        <!-- Contenido Real -->
                        <div id="detalle-auto-body" class="hidden">
                            <!-- Galería -->
                            <div class="bg-black">
                                <img id="detalle-auto-img-main" src="https://placehold.co/800x600/111111/555555?text=Cargando..." alt="Auto" class="w-full h-64 md:h-96 object-cover">
                                <div id="detalle-auto-img-thumbs" class="flex p-2 gap-2 overflow-x-auto">
                                    <!-- JS Rellena esto -->
                                </div>
                            </div>
                            <!-- Info -->
                            <div class="p-6 md:p-10">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <!-- Columna Izquierda (Info) -->
                                    <div class="md:col-span-2">
                                        <h2 id="detalle-auto-titulo" class="text-3xl md:text-4xl font-extrabold text-aj-dark"></h2>
                                        <p id="detalle-auto-precio" class="text-4xl font-bold text-aj-brand mt-2 mb-6"></p>

                                        <div class="grid grid-cols-3 gap-4 text-center border-y border-aj-gray-light py-4 mb-6">
                                            <div>
                                                <i data-lucide="calendar" class="w-8 h-8 mx-auto text-aj-text-light mb-1"></i>
                                                <span class="block text-sm font-semibold text-aj-text-light">Año</span>
                                                <span id="detalle-auto-ano" class="block text-lg font-bold text-aj-dark"></span>
                                            </div>
                                            <div>
                                                <i data-lucide="gauge" class="w-8 h-8 mx-auto text-aj-text-light mb-1"></i>
                                                <span class="block text-sm font-semibold text-aj-text-light">Kilometraje</span>
                                                <span id="detalle-auto-km" class="block text-lg font-bold text-aj-dark"></span>
                                            </div>
                                            <div>
                                                <i data-lucide="car" class="w-8 h-8 mx-auto text-aj-text-light mb-1"></i>
                                                <span class="block text-sm font-semibold text-aj-text-light">Marca</span>
                                                <span id="detalle-auto-marca" class="block text-lg font-bold text-aj-dark"></span>
                                            </div>
                                        </div>

                                        <h3 class="text-xl font-bold text-aj-dark mb-2">Descripción</h3>
                                        <p id="detalle-auto-descripcion" class="text-aj-text-light prose"></p>
                                    </div>
                                    <!-- Columna Derecha (Contacto) -->
                                    <div class="md:col-span-1">
                                        <div class="bg-aj-gray-light p-6 rounded-lg shadow-sm sticky top-20">
                                            <p class="font-bold text-lg text-aj-dark text-center mb-4">¿Te interesa?</p>
                                            <!-- BOTÓN WPP (VERDE) CON PULSO -->
                                            <a id="detalle-auto-wpp-btn" href="#" target="_blank" class="bg-green-500 text-white px-5 py-3 rounded-lg font-semibold shadow-md transition-all duration-300 ease-in-out hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-offset-2 transform hover:-translate-y-0.5 w-full flex items-center justify-center text-lg btn-pulse-wpp">
                                                <i data-lucide="message-circle" class="w-6 h-6 mr-2"></i>
                                                Consultar por WhatsApp
                                            </a>
                                            <p class="text-xs text-aj-text-light text-center mt-4">Serás redirigido a WhatsApp para hablar con un vendedor.</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Página: Admin (CMS) - (NUEVO ESTILO "FINO") -->
            <section id="page-admin" class="page-section hidden bg-aj-gray-light py-16 sm:py-24" style="min-height: 80vh;">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                    
                    <!-- Contenedor de Login (Estilo Fino) -->
                    <div id="admin-login-container" class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-xl animate__animated animate__fadeInUp">
                        <img src="https://i.postimg.cc/XqLD6P0p/wmremove-transformed-1.png" alt="Logo" class="w-48 mx-auto mb-6 rounded-md">
                        <h2 class="text-2xl font-bold text-aj-dark text-center mb-6">Acceso Admin</h2>
                        <form id="admin-login-form" class="space-y-4">
                            <div>
                                <label for="login-user" class="block text-sm font-semibold text-gray-700 mb-1">Usuario</label>
                                <input type="text" id="login-user" class="block w-full p-3 border border-gray-300 rounded-lg shadow-sm text-lg focus:outline-none focus:ring-2 focus:ring-aj-brand focus:border-transparent" required>
                            </div>
                            <div>
                                <label for="login-pass" class="block text-sm font-semibold text-gray-700 mb-1">Contraseña</label>
                                <input type="password" id="login-pass" class="block w-full p-3 border border-gray-300 rounded-lg shadow-sm text-lg focus:outline-none focus:ring-2 focus:ring-aj-brand focus:border-transparent" required>
                            </div>
                            <p id="login-error" class="text-red-600 text-sm font-semibold"></p>
                            <!-- BOTÓN ROJO -->
                            <button type="submit" class="bg-aj-brand text-white px-5 py-3 rounded-lg font-semibold shadow-md transition-all duration-300 ease-in-out hover:bg-aj-brand-dark focus:outline-none focus:ring-2 focus:ring-aj-brand focus:ring-offset-2 transform hover:-translate-y-0.5 w-full text-lg">
                                Entrar
                            </button>
                        </form>
                    </div>

                    <!-- Panel de Admin (Estilo Fino) -->
                    <div id="admin-panel" class="hidden">
                        <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-10 gap-4">
                            <div>
                                <h2 class="text-4xl font-extrabold text-aj-dark">Panel de Administración</h2>
                                <p class="text-aj-text-light text-lg">Hola Juanito. Desde acá podés manejar tu página.</p>
                            </div>
                            <!-- BOTÓN SALIR (OUTLINE) -->
                            <button id="admin-logout-btn" class="border-2 border-aj-brand text-aj-brand px-5 py-3 rounded-lg font-semibold shadow-sm transition-all duration-300 ease-in-out hover:bg-aj-brand hover:text-white focus:outline-none focus:ring-2 focus:ring-aj-brand focus:ring-offset-2 inline-flex items-center justify-center sm:w-auto">
                                <i data-lucide="log-out" class="w-5 h-5 mr-2 inline-block"></i>Salir
                            </button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            
                            <!-- Col: Gestionar Autos -->
                            <div class="bg-aj-white p-8 rounded-lg shadow-xl animate__animated animate__fadeInUp">
                                <h3 class="text-2xl font-bold text-aj-dark mb-6">Gestionar Vehículos</h3>
                                
                                <button id="admin-add-car-btn" class="bg-aj-brand text-white px-5 py-3 rounded-lg font-semibold shadow-md transition-all duration-300 ease-in-out hover:bg-aj-brand-dark focus:outline-none focus:ring-2 focus:ring-aj-brand focus:ring-offset-2 transform hover:-translate-y-0.5 w-full text-lg py-4 flex items-center justify-center mb-6">
                                    <i data-lucide="plus-circle" class="w-6 h-6 mr-2"></i>
                                    Agregar Auto Nuevo
                                </button>

                                <h4 class="text-lg font-semibold text-aj-dark mb-3">Autos Publicados</h4>
                                <div id="admin-car-list-loader" class="text-center">
                                    <p class="text-aj-text-light">Cargando autos...</p>
                                </div>
                                <div id="admin-car-list" class="space-y-3 max-h-96 overflow-y-auto pr-2">
                                    <!-- JS Rellena esto -->
                                </div>
                                <p id="admin-no-cars" class="hidden text-aj-text-light text-center bg-aj-gray-light p-4 rounded-lg">No hay autos cargados. ¡Agregá el primero!</p>
                            </div>

                            <!-- Col: Info de Contacto -->
                            <div class="bg-aj-white p-8 rounded-lg shadow-xl animate__animated animate__fadeInUp" style="animation-delay: 0.2s;">
                                <h3 class="text-2xl font-bold text-aj-dark mb-6">Gestionar Info de Contacto</h3>
                                <form id="admin-contact-form" class="space-y-4">
                                    <div>
                                        <label for="contact-form-wpp" class="block text-sm font-semibold text-gray-700 mb-1">Número de WhatsApp (Ej: 54911...)</label>
                                        <input type="text" id="contact-form-wpp" class="block w-full p-3 border border-gray-300 rounded-lg shadow-sm text-lg focus:outline-none focus:ring-2 focus:ring-aj-brand focus:border-transparent" placeholder="54911...">
                                    </div>
                                    <div>
                                        <label for="contact-form-address" class="block text-sm font-semibold text-gray-700 mb-1">Dirección (Texto)</label>
                                        <input type="text" id="contact-form-address" class="block w-full p-3 border border-gray-300 rounded-lg shadow-sm text-lg focus:outline-none focus:ring-2 focus:ring-aj-brand focus:border-transparent" placeholder="D Elia Maestro 4969, José C. Paz">
                                    </div>
                                    <div>
                                        <label for="contact-form-map-url" class="block text-sm font-semibold text-gray-700 mb-1">URL de Google Maps (Link "Compartir")</label>
                                        <input type="url" id="contact-form-map-url" class="block w-full p-3 border border-gray-300 rounded-lg shadow-sm text-lg focus:outline-none focus:ring-2 focus:ring-aj-brand focus:border-transparent" placeholder="https://goo.gl/maps/...">
                                    </div>
                                    <div>
                                        <label for="contact-form-hours" class="block text-sm font-semibold text-gray-700 mb-1">Horarios (Texto)</label>
                                        <input type="text" id="contact-form-hours" class="block w-full p-3 border border-gray-300 rounded-lg shadow-sm text-lg focus:outline-none focus:ring-2 focus:ring-aj-brand focus:border-transparent" placeholder="Lunes a Sábado: 9 a.m. – 7:15 p.m.">
                                    </div>
                                    <button type="submit" id="admin-contact-submit-btn" class="bg-aj-brand text-white px-5 py-3 rounded-lg font-semibold shadow-md transition-all duration-300 ease-in-out hover:bg-aj-brand-dark focus:outline-none focus:ring-2 focus:ring-aj-brand focus:ring-offset-2 transform hover:-translate-y-0.5 w-full text-lg py-4 inline-flex items-center justify-center">
                                        <i data-lucide="save" class="w-5 h-5 mr-2"></i>Guardar Info de Contacto
                                    </button>
                                </form>
                            </div>

                        </div>
                    </div>
                </div>
            </section>

        </main>

        <!-- Footer (Estilo Fino) -->
        <footer class="bg-aj-white border-t border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
                <div class="flex flex-col md:flex-row justify-between items-center text-center md:text-left">
                    <div class="mb-4 md:mb-0">
                        <img src="https://i.postimg.cc/XqLD6P0p/wmremove-transformed-1.png" alt="Logo Automotores Juanito" class="w-48 h-auto mx-auto md:mx-0 rounded-md">
                    </div>
                    <div class="flex space-x-6 text-aj-text-light font-semibold">
                        <a href="#home" class="hover:text-aj-brand">Inicio</a>
                        <a href="#catalogo-section" class="hover:text-aj-brand">Catálogo</a>
                        <a href="#contacto-section" class="hover:text-aj-brand">Contacto</a>
                        <a href="#admin" class="hover:text-aj-brand">Admin</a>
                    </div>
                </div>
                <div class="mt-8 pt-8 border-t border-gray-200 text-center text-gray-400 text-sm">
                    <p>© <span id="current-year"></span> Automotores Juanito. Todos los derechos reservados.</p>
                </div>
            </div>
        </footer>
    </div>

    <!-- Modales de Admin (Estilo Fino) -->

    <!-- Modal: Formulario de Auto (Admin) -->
    <div id="car-form-modal" class="fixed inset-0 z-40 bg-black/80 backdrop-blur-sm hidden items-start justify-center p-4 overflow-y-auto">
        <div class="bg-white w-full max-w-2xl rounded-lg shadow-2xl my-10 animate__animated animate__fadeInUp" style="animation-duration: 0.5s;">
            <form id="car-form" class="p-6 md:p-8 space-y-6">
                <div class="flex justify-between items-center">
                    <h3 id="car-form-title" class="text-2xl font-bold text-aj-dark"></h3>
                    <button type="button" id="car-form-close-btn" class="text-gray-500 hover:text-aj-dark">
                        <i data-lucide="x" class="w-7 h-7"></i>
                    </button>
                </div>

                <input type="hidden" id="car-form-id">

                <!-- Fotos -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Fotos del vehículo</label>
                    <input type="file" id="car-form-fotos" multiple accept="image/*" class="block w-full text-sm text-gray-500
                        file:mr-4 file:py-2 file:px-4
                        file:rounded-lg file:border-0
                        file:text-sm file:font-semibold
                        file:bg-red-50 file:text-aj-brand
                        hover:file:bg-red-100
                    ">
                    <p class="text-xs text-gray-500 mt-1">Podés subir varias a la vez. Se comprimirán automáticamente. La primera será la principal.</p>
                    <div id="car-form-upload-progress" class="hidden w-full bg-gray-200 rounded-full h-2.5 mt-2">
                        <div id="car-form-upload-bar" class="bg-red-600 h-2.5 rounded-full" style="width: 0%"></div>
                    </div>
                    <p id="car-form-upload-status" class="hidden text-sm text-red-600 mt-1"></p>
                    <div id="car-form-image-previews" class="mt-4 flex flex-wrap gap-2">
                        <!-- Previews -->
                    </div>
                </div>

                <!-- Grid de Datos -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4">
                    <div>
                        <label for="car-form-marca" class="block text-sm font-semibold text-gray-700 mb-1">Marca</label>
                        <input type="text" id="car-form-marca" class="block w-full p-3 border border-gray-300 rounded-lg shadow-sm text-lg focus:outline-none focus:ring-2 focus:ring-aj-brand focus:border-transparent" required>
                    </div>
                    <div>
                        <label for="car-form-modelo" class="block text-sm font-semibold text-gray-700 mb-1">Modelo</label>
                        <input type="text" id="car-form-modelo" class="block w-full p-3 border border-gray-300 rounded-lg shadow-sm text-lg focus:outline-none focus:ring-2 focus:ring-aj-brand focus:border-transparent" required>
                    </div>
                    <div>
                        <label for="car-form-precio" class="block text-sm font-semibold text-gray-700 mb-1">Precio (Solo números)</label>
                        <input type="number" id="car-form-precio" class="block w-full p-3 border border-gray-300 rounded-lg shadow-sm text-lg focus:outline-none focus:ring-2 focus:ring-aj-brand focus:border-transparent" placeholder="10000000" required>
                    </div>
                    <div>
                        <label for="car-form-ano" class="block text-sm font-semibold text-gray-700 mb-1">Año</label>
                        <input type="number" id="car-form-ano" class="block w-full p-3 border border-gray-300 rounded-lg shadow-sm text-lg focus:outline-none focus:ring-2 focus:ring-aj-brand focus:border-transparent" placeholder="2020" required>
                    </div>
                    <div class="md:col-span-2">
                        <label for="car-form-km" class="block text-sm font-semibold text-gray-700 mb-1">Kilometraje (Solo números)</label>
                        <input type="number" id="car-form-km" class="block w-full p-3 border border-gray-300 rounded-lg shadow-sm text-lg focus:outline-none focus:ring-2 focus:ring-aj-brand focus:border-transparent" placeholder="50000" required>
                    </div>
                </div>
                
                <!-- Descripción -->
                <div>
                    <label for="car-form-descripcion" class="block text-sm font-semibold text-gray-700 mb-1">Descripción</label>
                    <textarea id="car-form-descripcion" rows="4" class="block w-full p-3 border border-gray-300 rounded-lg shadow-sm text-lg focus:outline-none focus:ring-2 focus:ring-aj-brand focus:border-transparent" placeholder="Ej: Único dueño, VTV al día, listo para transferir..."></textarea>
                </div>

                <!-- Status (Vendido) -->
                <div class="flex items-center">
                    <input id="car-form-vendido" type="checkbox" class="h-5 w-5 text-aj-brand border-gray-300 rounded focus:ring-aj-brand">
                    <label for="car-form-vendido" class="ml-2 block text-lg font-medium text-gray-900">Marcar como "Vendido"</label>
                </div>

                <!-- Botones -->
                <div class="flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-4">
                    <button type="button" id="car-form-cancel-btn" class="bg-gray-200 text-gray-800 px-5 py-3 rounded-lg font-semibold shadow-sm transition-all duration-300 ease-in-out hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 w-full sm:w-auto mt-2 sm:mt-0 inline-flex items-center justify-center">
                        <i data-lucide="x" class="w-5 h-5 mr-2 -ml-1"></i>Cancelar
                    </button>
                    <button type="submit" id="car-form-submit-btn" class="bg-aj-brand text-white px-5 py-3 rounded-lg font-semibold shadow-md transition-all duration-300 ease-in-out hover:bg-aj-brand-dark focus:outline-none focus:ring-2 focus:ring-aj-brand focus:ring-offset-2 transform hover:-translate-y-0.5 w-full sm:w-auto inline-flex items-center justify-center">
                        <i data-lucide="check" class="w-5 h-5 mr-2 -ml-1"></i>Guardar Vehículo
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Confirmar Eliminar (Admin) -->
    <div id="delete-modal" class="fixed inset-0 z-50 bg-black/80 backdrop-blur-sm hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm rounded-lg shadow-2xl p-8 text-center animate__animated animate__fadeInUp" style="animation-duration: 0.5s;">
            <i data-lucide="alert-triangle" class="w-16 h-16 text-red-500 mx-auto mb-4"></i>
            <h3 class="text-2xl font-bold text-aj-dark mb-2">¿Estás seguro?</h3>
            <p class="text-aj-text-light mb-6">Esta acción no se puede deshacer. El vehículo se eliminará permanentemente.</p>
            <div class="flex flex-col-reverse sm:flex-row sm:justify-center sm:space-x-4">
                <button id="delete-modal-cancel-btn" class="bg-gray-200 text-gray-800 px-5 py-3 rounded-lg font-semibold shadow-sm transition-all duration-300 ease-in-out hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 w-full sm:w-auto mt-2 sm:mt-0 inline-flex items-center justify-center">
                    <i data-lucide="x" class="w-5 h-5 mr-2 -ml-1"></i>Cancelar
                </button>
                <button id="delete-modal-confirm-btn" class="bg-aj-brand text-white px-5 py-3 rounded-lg font-semibold shadow-md transition-all duration-300 ease-in-out hover:bg-aj-brand-dark focus:outline-none focus:ring-2 focus:ring-aj-brand focus:ring-offset-2 w-full sm:w-auto inline-flex items-center justify-center">
                    <i data-lucide="trash-2" class="w-5 h-5 mr-2 -ml-1"></i>Sí, eliminar
                </button>
            </div>
        </div>
    </div>

    <!-- Toast: Notificación (Estilo Fino) -->
    <div id="notification-toast" class="fixed bottom-5 right-5 z-50 bg-aj-dark text-aj-white px-5 py-3 rounded-lg shadow-xl translate-x-[200%] transition-transform duration-300 ease-out">
        <p id="notification-message"></p>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // (NUEVO) Importar Lucide como un módulo
        import * as lucide from 'https://cdn.jsdelivr.net/npm/lucide@latest/dist/lucide.esm.js';

        // Importar servicios de Firebase (v12.5.0)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-analytics.js";
        import { 
            getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, 
            deleteDoc, onSnapshot, collection, query, serverTimestamp, setLogLevel
        } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-firestore.js";

        // --- Configuración Global ---
        const firebaseConfig = {
            apiKey: "AIzaSyAPMJC9VUgDS8ZhETDP1ix1_xie0r5l9iU",
            authDomain: "juanitosautomotores.firebaseapp.com",
            projectId: "juanitosautomotores",
            storageBucket: "juanitosautomotores.firebasestorage.app",
            messagingSenderId: "796050118269",
            appId: "1:796050118269:web:e6d7a85c579b5a68298314",
            measurementId: "G-8L0481YL3F"
          };
          
        const appId = firebaseConfig.projectId; 
        
        let app, db, analytics;
        let currentCarIdToDelete = null;
        let currentCarToEdit = null;
        let cachedCarData = [];
        let isAdminLoggedIn = false;
        
        const PUBLIC_DATA_PATH = `artifacts/${appId}/public/data`;
        let carCollection;
        let siteConfigDoc;

        // --- Inicialización de la App ---
        function initializeMainApp() {
            try {
                app = initializeApp(firebaseConfig);
                analytics = getAnalytics(app);
                db = getFirestore(app);
                setLogLevel('Debug');

                carCollection = collection(db, `${PUBLIC_DATA_PATH}/cars`);
                siteConfigDoc = doc(db, `${PUBLIC_DATA_PATH}/siteConfig/contact`);

                loadInitialData();
                setupEventListeners();
                setupScrollAnimations(); // Configurar observer de scroll
                lucide.createIcons(); // <--- AHORA SÍ lucide está definido
                document.getElementById('current-year').textContent = new Date().getFullYear();

            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                document.getElementById('app-loader-text').textContent = 'Error al conectar. Intenta recargar la página.';
                document.getElementById('app-loader-text').classList.add('text-red-500');
            }
        }

        // --- Lógica de Ruteo y Navegación ---
        function handleRouting() {
            const hash = window.location.hash || '#home';
            
            document.querySelectorAll('.page-section').forEach(page => {
                page.classList.add('hidden');
            });
            
            if (hash === '#admin') {
                const adminPage = document.getElementById('page-admin');
                adminPage.classList.remove('hidden');
                showAdminPanel(isAdminLoggedIn);
            } else {
                const homePage = document.getElementById('page-home');
                homePage.classList.remove('hidden');
                
                if (hash !== '#home') {
                    let targetId = hash.substring(1);
                    // Normalizar hashes
                    if (targetId === 'catalogo') targetId = 'catalogo-section';
                    if (targetId === 'contacto') targetId = 'contacto-section';
                    if (targetId === 'destacados') targetId = 'ultimos-ingresos-section';

                    const targetElement = document.getElementById(targetId);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }
            }
            
            // Manejar manualmente el link de Admin
            document.querySelectorAll('.nav-link').forEach(link => {
                const linkHash = link.getAttribute('href');
                if (linkHash === '#admin') {
                    if (hash === '#admin') {
                        link.classList.add('border-aj-brand', 'text-aj-dark', 'border-l-4');
                        link.classList.remove('border-transparent', 'text-aj-text-light');
                    } else {
                        link.classList.remove('border-aj-brand', 'text-aj-dark', 'border-l-4');
                        link.classList.add('border-transparent', 'text-aj-text-light');
                    }
                }
            });

            document.getElementById('mobile-menu').classList.add('hidden');
        }

        function showAdminPanel(isAuthed) {
            const loginContainer = document.getElementById('admin-login-container');
            const adminPanel = document.getElementById('admin-panel');
            
            if (isAuthed) {
                loginContainer.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                loadContactDataForAdmin();
            } else {
                loginContainer.classList.remove('hidden');
                adminPanel.classList.add('hidden');
                document.getElementById('admin-login-form').reset();
                document.getElementById('login-error').textContent = '';
            }
        }
        
        // --- Lógica de Login ---
        function handleAdminLogin(e) {
            e.preventDefault();
            const user = document.getElementById('login-user').value;
            const pass = document.getElementById('login-pass').value;
            const errorEl = document.getElementById('login-error');
            
            if (user === 'juanmng2025' && pass === 'automotoresjuanitos2025jcp') {
                isAdminLoggedIn = true;
                showAdminPanel(true);
                showNotification('¡Bienvenido, Juanito!');
            } else {
                isAdminLoggedIn = false;
                errorEl.textContent = 'Usuario o contraseña incorrectos.';
                const loginContainer = document.getElementById('admin-login-container');
                loginContainer.classList.add('animate__animated', 'animate__shakeX');
                setTimeout(() => loginContainer.classList.remove('animate__animated', 'animate__shakeX'), 1000);
            }
        }
        
        function handleAdminLogout() {
            isAdminLoggedIn = false;
            showAdminPanel(false);
            showNotification('Has cerrado sesión');
        }
        
        // --- Carga de Datos (Firestore) ---
        function loadInitialData() {
            if (!db || !carCollection || !siteConfigDoc) {
                console.error("Firestore no está inicializado.");
                return;
            }

            // 1. Listener para autos
            try {
                const q = query(collection(db, `${PUBLIC_DATA_PATH}/cars`));
                onSnapshot(q, (snapshot) => {
                    const cars = [];
                    snapshot.forEach(doc => {
                        cars.push({ id: doc.id, ...doc.data() });
                    });
                    
                    cars.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    cachedCarData = cars;
                    
                    renderDestacados();
                    renderCatalogo();
                    renderAdminCarList();
                    populateMarcaFilter();
                    lucide.createIcons();
                    
                }, (error) => {
                    console.error("Error en listener de autos:", error);
                    document.getElementById('home-destacados-loader').innerHTML = '<p class="text-red-500">Error al cargar autos</p>';
                    document.getElementById('catalogo-loader').innerHTML = '<p class="text-red-500">Error al cargar autos</p>';
                    document.getElementById('admin-car-list-loader').innerHTML = '<p class="text-red-500">Error al cargar autos</p>';
                });

            } catch (error) {
                console.error("Error configurando listener de autos:", error);
            }

            // 2. Listener para info de contacto
            try {
                onSnapshot(doc(db, `${PUBLIC_DATA_PATH}/siteConfig/contact`), (doc) => {
                    renderContactInfo(doc.exists() ? doc.data() : {});
                }, (error) => {
                    console.error("Error en listener de contacto:", error);
                    renderContactInfo({});
                });

            } catch (error) {
                console.error("Error configurando listener de contacto:", error);
            }
            
            document.getElementById('app-loader').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            document.getElementById('app-content').classList.add('flex', 'flex-col');
        }
        
        async function loadContactDataForAdmin() {
             try {
                const docSnap = await getDoc(siteConfigDoc);
                fillContactForm(docSnap.exists() ? docSnap.data() : {});
             } catch (error) {
                console.error("Error al cargar datos de contacto para admin:", error);
             }
        }
        
        // --- Lógica de Renderizado (Público) ---
        function renderDestacados() {
            const grid = document.getElementById('home-destacados-grid');
            const loader = document.getElementById('home-destacados-loader');
            
            const autosVisibles = cachedCarData.filter(car => !car.status?.vendido);
            const destacados = autosVisibles.slice(0, 3);
            
            grid.innerHTML = '';
            
            if (destacados.length > 0) {
                destacados.forEach((car, index) => {
                    grid.appendChild(createCarCard(car, index * 100)); // Añadir delay para animación
                });
                loader.classList.add('hidden');
            } else {
                loader.innerHTML = '<p class="text-aj-text-light">No hay autos destacados por el momento.</p>';
                loader.classList.remove('hidden');
            }
        }

        function renderCatalogo() {
            const grid = document.getElementById('catalogo-grid');
            const loader = document.getElementById('catalogo-loader');
            const noResults = document.getElementById('catalogo-no-results');
            
            const filteredCars = getFilteredCars();
            
            grid.innerHTML = '';
            
            if (filteredCars.length > 0) {
                filteredCars.forEach((car, index) => {
                    grid.appendChild(createCarCard(car, index * 50)); // Delay más corto para el catálogo
                });
                loader.classList.add('hidden');
                noResults.classList.add('hidden');
            } else {
                loader.classList.add('hidden');
                noResults.classList.remove('hidden');
            }
        }

        function createCarCard(car, delay = 0) {
            const card = document.createElement('div');
            // NUEVO ESTILO DE CARD "FINO"
            card.className = 'bg-white rounded-lg shadow-lg overflow-hidden transition-all duration-300 cursor-pointer group hover:shadow-2xl hover:-translate-y-1.5 animate-on-scroll'; 
            card.style.animationDelay = `${delay}ms`; // Delay para animación escalonada
            card.setAttribute('data-id', car.id);
            card.onclick = () => showDetalleAutoModal(car.id);

            const imageUrl = car.imageUrls && car.imageUrls.length > 0 
                ? car.imageUrls[0] 
                : 'https://placehold.co/600x400/EAEAEA/999999?text=Sin+Foto';

            const precioFormateado = car.precio 
                ? `$${new Intl.NumberFormat('es-AR').format(car.precio)}`
                : 'Consultar Precio';

            card.innerHTML = `
                <div class="relative overflow-hidden">
                    <img src="${imageUrl}" alt="${car.marca} ${car.modelo}" class="w-full h-56 object-cover transition-transform duration-500 group-hover:scale-105">
                </div>
                <div class="p-6">
                    <h3 class="text-xl font-bold text-aj-dark truncate">${car.marca} ${car.modelo}</h3>
                    <p class="text-2xl font-extrabold text-aj-brand mt-1 mb-3">${precioFormateado}</p>
                    <div class="flex justify-between text-sm text-aj-text-light border-t border-aj-gray-light pt-3">
                        <span class="font-semibold">${car.ano || 'N/A'}</span>
                        <span class="font-semibold">${(car.km ? new Intl.NumberFormat('es-AR').format(car.km) : '0')} km</span>
                    </div>
                </div>
            `;
            return card;
        }

        function populateMarcaFilter() {
            const select = document.getElementById('filter-marca');
            const marcas = [...new Set(cachedCarData.map(car => car.marca))];
            marcas.sort();
            
            while (select.options.length > 1) { select.remove(1); }
            
            marcas.forEach(marca => {
                if(marca) {
                    const option = document.createElement('option');
                    option.value = marca;
                    option.textContent = marca;
                    select.appendChild(option);
                }
            });
        }

        function getFilteredCars() {
            const marca = document.getElementById('filter-marca').value;
            const precio = Number(document.getElementById('filter-precio').value);
            const ano = Number(document.getElementById('filter-ano').value);
            const sort = document.getElementById('filter-sort').value;
            
            let filtered = cachedCarData.filter(car => !car.status?.vendido);

            if (marca) { filtered = filtered.filter(car => car.marca === marca); }
            if (precio) { filtered = filtered.filter(car => car.precio <= precio); }
            if (ano) { filtered = filtered.filter(car => car.ano >= ano); }
            
            switch (sort) {
                case 'precio-asc': filtered.sort((a, b) => (a.precio || 0) - (b.precio || 0)); break;
                case 'precio-desc': filtered.sort((a, b) => (b.precio || 0) - (a.precio || 0)); break;
                case 'recientes': default: break;
            }
            
            return filtered;
        }

        function renderContactInfo(data) {
            const defaults = {
                wpp: '5491112345678',
                address: 'D Elia Maestro 4969, José C. Paz, Provincia de Buenos Aires',
                mapUrl: 'https://www.google.com/maps?q=D+Elia+Maestro+4969,+Jos%C3%A9+C.+Paz',
                hours: 'Lunes a Sábado: 9 a.m. – 7:15 p.m. (flexible)'
            };

            const wpp = data.wpp || defaults.wpp;
            const address = data.address || defaults.address;
            const mapUrl = data.mapUrl || defaults.mapUrl;
            const hours = data.hours || defaults.hours;

            document.getElementById('contact-wpp-link').href = `https://api.whatsapp.com/send?phone=${wpp.replace(/\D/g, '')}`;
            document.getElementById('contact-map-link').href = mapUrl;
            
            document.getElementById('contact-wpp-text').textContent = wpp;
            document.getElementById('contact-map-text').textContent = address;
            document.getElementById('contact-hours-text').textContent = hours;
            
            const iframe = document.getElementById('contact-map-iframe');
            if (data.mapUrl && data.mapUrl.includes('google.com/maps')) {
                 try {
                    const url = new URL(data.mapUrl);
                    if (url.pathname.includes('/place/')) {
                         iframe.src = `https://www.google.com/maps/embed/v1/place?key=${firebaseConfig.apiKey.split('AIza')[1]}&q=${encodeURIComponent(address)}`;
                    } else if (url.searchParams.get('pb')) {
                         iframe.src = data.mapUrl.replace('/maps?', '/maps/embed?');
                    } else {
                         iframe.src = `https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3287.619089201919!2d-58.70588102377481!3d-34.51261175373656!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x95bcbd0643b17c75%3A0x633d07d4e46358c!2sD'El%C3%ADa%2C+Maestro+4969%2C+B1665+Jos%C3%A9+C.+Paz%2C+Provincia+de+Buenos+Aires!5e0!3m2!1ses-419!2sar!4v1731037415442!5m2!1ses-419!2sar`;
                    }
                 } catch (e) {
                      iframe.src = `https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d3287.619089201919!2d-58.70588102377481!3d-34.51261175373656!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x95bcbd0643b17c75%3A0x633d07d4e46358c!2sD'El%C3%ADa%2C+Maestro+4969%2C+B1665+Jos%C3%A9+C.+Paz%2C+Provincia+de+Buenos+Aires!5e0!3m2!1ses-419!2sar!4v1731037415442!5m2!1ses-419!2sar`;
                 }
            }
        }
        
        async function showDetalleAutoModal(carId) {
            const modal = document.getElementById('detalle-auto-modal');
            const loader = document.getElementById('detalle-auto-loader');
            const body = document.getElementById('detalle-auto-body');
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.classList.add('overflow-hidden');
            
            loader.classList.remove('hidden');
            body.classList.add('hidden');
            
            const car = cachedCarData.find(c => c.id === carId) || await (async () => {
                try {
                    const carDoc = await getDoc(doc(db, `${PUBLIC_DATA_PATH}/cars/${carId}`));
                    return carDoc.exists() ? carDoc.data() : null;
                } catch (error) {
                    return null;
                }
            })();
            
            if (car) {
                renderDetalleAuto(car);
            } else {
                loader.innerHTML = '<p class="text-red-500">Error: Auto no encontrado.</p>';
            }
        }
        
        function renderDetalleAuto(car) {
            const loader = document.getElementById('detalle-auto-loader');
            const body = document.getElementById('detalle-auto-body');

            const precioFormateado = car.precio 
                ? `$${new Intl.NumberFormat('es-AR').format(car.precio)}`
                : 'Consultar Precio';
            const kmFormateado = car.km 
                ? `${new Intl.NumberFormat('es-AR').format(car.km)} km`
                : 'N/A';
            const wppMsg = `Hola, estoy interesado en el ${car.marca} ${car.modelo} (${car.ano}) que vi en la web.`;
            const wppLink = `https://api.whatsapp.com/send?phone=${document.getElementById('contact-wpp-text').textContent.replace(/\D/g, '')}&text=${encodeURIComponent(wppMsg)}`;

            document.getElementById('detalle-auto-titulo').textContent = `${car.marca} ${car.modelo}`;
            document.getElementById('detalle-auto-precio').textContent = precioFormateado;
            document.getElementById('detalle-auto-ano').textContent = car.ano || 'N/A';
            document.getElementById('detalle-auto-km').textContent = kmFormateado;
            document.getElementById('detalle-auto-marca').textContent = car.marca || 'N/A';
            document.getElementById('detalle-auto-descripcion').textContent = car.descripcion || 'Sin descripción.';
            document.getElementById('detalle-auto-wpp-btn').href = wppLink;

            const mainImg = document.getElementById('detalle-auto-img-main');
            const thumbs = document.getElementById('detalle-auto-img-thumbs');
            thumbs.innerHTML = '';
            
            if (car.imageUrls && car.imageUrls.length > 0) {
                mainImg.src = car.imageUrls[0];
                
                car.imageUrls.forEach((url, index) => {
                    const thumb = document.createElement('img');
                    thumb.src = url;
                    thumb.className = `w-16 h-12 md:w-20 md:h-16 object-cover rounded-md cursor-pointer border-2 transition-all ${index === 0 ? 'border-aj-brand' : 'border-transparent'} hover:border-aj-brand`;
                    thumb.onclick = (e) => { 
                        mainImg.src = url;
                        thumbs.querySelectorAll('img').forEach(t => t.classList.replace('border-aj-brand', 'border-transparent'));
                        e.target.classList.replace('border-transparent', 'border-aj-brand');
                    };
                    thumbs.appendChild(thumb);
                });
            } else {
                mainImg.src = 'https://placehold.co/800x600/111111/555555?text=Sin+Foto';
            }

            loader.classList.add('hidden');
            body.classList.remove('hidden');
            lucide.createIcons();
        }

        function closeDetalleAutoModal() {
            const modal = document.getElementById('detalle-auto-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.classList.remove('overflow-hidden');
        }

        
        // --- Lógica de Renderizado (Admin) ---
        function renderAdminCarList() {
            const list = document.getElementById('admin-car-list');
            const loader = document.getElementById('admin-car-list-loader');
            const noCars = document.getElementById('admin-no-cars');
            
            list.innerHTML = '';
            
            if (cachedCarData.length > 0) {
                cachedCarData.forEach(car => {
                    list.appendChild(createAdminCarItem(car));
                });
                loader.classList.add('hidden');
                noCars.classList.add('hidden');
            } else {
                loader.classList.add('hidden');
                noCars.classList.remove('hidden');
            }
            lucide.createIcons();
        }

        function createAdminCarItem(car) {
            const item = document.createElement('div');
            item.className = 'bg-aj-gray-light p-3 rounded-lg flex items-center justify-between border border-gray-200';
            
            const imageUrl = car.imageUrls && car.imageUrls.length > 0
                ? car.imageUrls[0]
                : 'https://placehold.co/100x100/EAEAEA/999999?text=Sin+Foto';

            item.innerHTML = `
                <div class="flex items-center gap-3 overflow-hidden">
                    <img src="${imageUrl}" alt="${car.marca}" class="w-16 h-12 object-cover rounded-md flex-shrink-0">
                    <div class="overflow-hidden">
                        <p class="font-bold text-aj-dark truncate">${car.marca} ${car.modelo}</p>
                        <p class="text-sm text-aj-text-light">${car.status?.vendido ? '<span class="font-bold text-red-600">VENDIDO</span>' : 'Publicado'}</p>
                    </div>
                </div>
                <div class="flex-shrink-0 space-x-1">
                    <button class="admin-edit-btn p-2 text-aj-text-light hover:text-aj-brand" data-id="${car.id}" title="Editar">
                        <i data-lucide="edit" class="w-5 h-5"></i>
                    </button>
                    <button class="admin-delete-btn p-2 text-aj-text-light hover:text-red-600" data-id="${car.id}" title="Eliminar">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
            `;
            
            item.querySelector('.admin-edit-btn').onclick = (e) => { e.stopPropagation(); handleEditCar(car.id); };
            item.querySelector('.admin-delete-btn').onclick = (e) => { e.stopPropagation(); handleDeleteCar(car.id); };
            
            return item;
        }

        function fillContactForm(data) {
            const defaults = {
                wpp: '5491112345678',
                address: 'D Elia Maestro 4969, José C. Paz, Provincia de Buenos Aires',
                mapUrl: 'https://www.google.com/maps?q=D+Elia+Maestro+4969,+Jos%C3%A9+C.+Paz',
                hours: 'Lunes a Sábado: 9 a.m. – 7:15 p.m. (flexible)'
            };
            
            document.getElementById('contact-form-wpp').value = data.wpp || defaults.wpp;
            document.getElementById('contact-form-address').value = data.address || defaults.address;
            document.getElementById('contact-form-map-url').value = data.mapUrl || defaults.mapUrl;
            document.getElementById('contact-form-hours').value = data.hours || defaults.hours;
        }

        // --- Lógica de Formularios (Admin) ---
        async function handleContactFormSubmit(e) {
            e.preventDefault();
            const btn = document.getElementById('admin-contact-submit-btn');
            btn.disabled = true;
            btn.innerHTML = 'Guardando...';

            const data = {
                wpp: document.getElementById('contact-form-wpp').value,
                address: document.getElementById('contact-form-address').value,
                mapUrl: document.getElementById('contact-form-map-url').value,
                hours: document.getElementById('contact-form-hours').value
            };

            try {
                await setDoc(siteConfigDoc, data, { merge: true });
                showNotification("Info de contacto guardada con éxito");
            } catch (error) {
                console.error("Error al guardar info de contacto:", error);
                showNotification("Error al guardar la información", true);
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i data-lucide="save" class="w-5 h-5 mr-2"></i>Guardar Info de Contacto';
                lucide.createIcons();
            }
        }

        function showCarFormModal(car = null) {
            const modal = document.getElementById('car-form-modal');
            const form = document.getElementById('car-form');
            const title = document.getElementById('car-form-title');
            const idInput = document.getElementById('car-form-id');
            const vendidoCheckbox = document.getElementById('car-form-vendido');
            const imagePreviews = document.getElementById('car-form-image-previews');

            form.reset(); 
            imagePreviews.innerHTML = ''; 
            resetUploadUI(); 

            if (car) {
                currentCarToEdit = car; 
                title.textContent = 'Modificar Vehículo';
                idInput.value = car.id;
                document.getElementById('car-form-marca').value = car.marca || '';
                document.getElementById('car-form-modelo').value = car.modelo || '';
                document.getElementById('car-form-precio').value = car.precio || '';
                document.getElementById('car-form-ano').value = car.ano || '';
                document.getElementById('car-form-km').value = car.km || '';
                document.getElementById('car-form-descripcion').value = car.descripcion || '';
                vendidoCheckbox.checked = car.status?.vendido || false;
                
                if (car.imageUrls && car.imageUrls.length > 0) {
                    car.imageUrls.forEach(url => { 
                        if (url) imagePreviews.appendChild(createImagePreview(url));
                    });
                }
            } else {
                currentCarToEdit = null;
                title.textContent = 'Agregar Auto Nuevo';
                idInput.value = '';
                vendidoCheckbox.checked = false;
            }

            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.classList.add('overflow-hidden');
            lucide.createIcons();
        }
        
        function createImagePreview(url) { 
            const imgWrapper = document.createElement('div');
            imgWrapper.className = 'relative w-24 h-20 rounded-lg overflow-hidden border border-gray-200';
            imgWrapper.innerHTML = `<img src="${url}" class="w-full h-full object-cover">`;
            return imgWrapper;
        }

        function closeCarFormModal() {
            const modal = document.getElementById('car-form-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.classList.remove('overflow-hidden');
            currentCarToEdit = null;
        }

        async function handleCarFormSubmit(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('car-form-submit-btn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<svg class="animate-spin h-5 w-5 text-white mx-auto" xmlns="http://www.w.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>';

            const carId = document.getElementById('car-form-id').value;
            const files = document.getElementById('car-form-fotos').files;
            
            let imageUrls = currentCarToEdit?.imageUrls || []; 

            if (files.length > 0) {
                try {
                    const uploadProgressDiv = document.getElementById('car-form-upload-progress');
                    const uploadBar = document.getElementById('car-form-upload-bar');
                    const uploadStatus = document.getElementById('car-form-upload-status');
                    uploadProgressDiv.classList.remove('hidden');
                    uploadStatus.classList.remove('hidden');
                    uploadBar.style.width = '0%';
                    
                    const processedImages = [];
                    for (let i = 0; i < files.length; i++) {
                        uploadStatus.textContent = `Comprimiendo foto ${i + 1} de ${files.length}...`;
                        const base64String = await resizeImage(files[i]);
                        processedImages.push(base64String);
                        uploadBar.style.width = `${((i + 1) / files.length) * 100}%`;
                    }
                    
                    imageUrls = processedImages; 
                    uploadStatus.textContent = "¡Fotos comprimidas!";
                    
                } catch (error) {
                    showNotification("Error al comprimir las fotos", true);
                    resetSubmitButton();
                    resetUploadUI();
                    return;
                }
            }
            
            if (imageUrls.length === 0) {
                showNotification("Debes agregar al menos una foto", true);
                resetSubmitButton();
                resetUploadUI();
                return;
            }

            const carData = {
                marca: document.getElementById('car-form-marca').value,
                modelo: document.getElementById('car-form-modelo').value,
                precio: Number(document.getElementById('car-form-precio').value),
                ano: Number(document.getElementById('car-form-ano').value),
                km: Number(document.getElementById('car-form-km').value),
                descripcion: document.getElementById('car-form-descripcion').value,
                status: {
                    vendido: document.getElementById('car-form-vendido').checked
                },
                imageUrls: imageUrls 
            };

            try {
                if (carId) {
                    const carDoc = doc(db, `${PUBLIC_DATA_PATH}/cars/${carId}`);
                    await updateDoc(carDoc, { ...carData, updatedAt: serverTimestamp() });
                    showNotification("Vehículo modificado con éxito");
                } else {
                    await addDoc(carCollection, { ...carData, createdAt: serverTimestamp() });
                    showNotification("Vehículo agregado con éxito");
                }
                closeCarFormModal();
            } catch (error) {
                console.error("Error guardando en Firestore:", error);
                if (error.code === 'invalid-argument' && error.message.includes('bytes')) {
                     showNotification("Error: Una foto es demasiado grande. Intenta con menos fotos.", true);
                } else {
                     showNotification("Error al guardar en base de datos", true);
                }
            } finally {
                resetSubmitButton();
                resetUploadUI();
            }
        }
        
        function resetSubmitButton() {
            const submitBtn = document.getElementById('car-form-submit-btn');
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i data-lucide="check" class="w-5 h-5 mr-2 -ml-1"></i>Guardar Vehículo';
            lucide.createIcons();
        }

        function handleEditCar(carId) {
            const car = cachedCarData.find(c => c.id === carId);
            if (car) { showCarFormModal(car); } 
            else { showNotification("Error: no se encontró ese auto", true); }
        }

        function handleDeleteCar(carId) {
            currentCarIdToDelete = carId;
            const modal = document.getElementById('delete-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            lucide.createIcons();
        }

        function closeDeleteModal() {
            const modal = document.getElementById('delete-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.classList.remove('overflow-hidden');
            currentCarIdToDelete = null;
        }

        async function confirmDeleteCar() {
            if (!currentCarIdToDelete) return;
            const carId = currentCarIdToDelete;
            closeDeleteModal(); 

            try {
                await deleteDoc(doc(db, `${PUBLIC_DATA_PATH}/cars/${carId}`));
                showNotification("Vehículo eliminado permanentemente");
            } catch (error) {
                showNotification("Error al eliminar el vehículo", true);
            }
        }


        // --- Lógica de Procesamiento de Imágenes ---
        function resizeImage(file) {
            return new Promise((resolve, reject) => {
                const MAX_WIDTH = 1024; 
                const MAX_HEIGHT = 1024;
                const QUALITY = 0.7; 

                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        let width = img.width;
                        let height = img.height;
                        if (width > height) {
                            if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        } else {
                            if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                        }
                        const canvas = document.createElement('canvas');
                        canvas.width = width;
                        canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        const dataUrl = canvas.toDataURL('image/jpeg', QUALITY);
                        resolve(dataUrl);
                    };
                    img.onerror = (error) => { reject(error); };
                };
                reader.onerror = (error) => { reject(error); };
            });
        }

        function resetUploadUI() {
            document.getElementById('car-form-upload-progress').classList.add('hidden');
            document.getElementById('car-form-upload-status').classList.add('hidden');
            document.getElementById('car-form-upload-bar').style.width = '0%';
            document.getElementById('car-form-upload-status').textContent = '';
        }
        

        // --- Utilidades ---
        function showNotification(message, isError = false) {
            const toast = document.getElementById('notification-toast');
            const messageEl = document.getElementById('notification-message');
            messageEl.textContent = message;
            if (isError) {
                toast.classList.add('bg-red-600', 'text-white');
                toast.classList.remove('bg-aj-dark');
            } else {
                toast.classList.remove('bg-red-600');
                toast.classList.add('bg-aj-dark', 'text-white');
            }
            toast.classList.remove('translate-x-[200%]');
            setTimeout(() => {
                toast.classList.add('translate-x-[200%]');
            }, 3000); 
        }
        
        // --- Animación de Scroll (Nav Activo + Animate.css) ---
        function setupScrollAnimations() {
            // Secciones a observar
            const sections = document.querySelectorAll('.animate-on-scroll');
            // Secciones de la NAV
            const navSections = document.querySelectorAll('#home, #ultimos-ingresos-section, #catalogo-section, #contacto-section');
            
            // Observer para animaciones de entrada (Animate.css)
            const animationObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('animate__animated', 'animate__fadeInUp');
                        entry.target.style.opacity = 1; // Hacer visible
                        observer.unobserve(entry.target); // No animar de nuevo
                    }
                });
            }, { threshold: 0.1 });

            sections.forEach(section => {
                if(section) animationObserver.observe(section);
            });
            
            // Observer para la NAV activa
            const navObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const id = entry.target.id;
                    const isNavSection = ['home', 'ultimos-ingresos-section', 'catalogo-section', 'contacto-section'].includes(id);

                    if (entry.isIntersecting && isNavSection && window.location.hash !== '#admin') {
                        document.querySelectorAll('.nav-link:not([href="#admin"])').forEach(link => {
                            link.classList.remove('border-aj-brand', 'text-aj-dark', 'border-l-4');
                            link.classList.add('border-transparent', 'text-aj-text-light');
                        });

                        const matchingLinks = document.querySelectorAll(`.nav-link[href="#${id}"]`);
                        matchingLinks.forEach(link => {
                            link.classList.add('border-aj-brand', 'text-aj-dark', 'border-l-4');
                            link.classList.remove('border-transparent', 'text-aj-text-light');
                        });
                    }
                });
            }, { 
                threshold: 0.1,
                rootMargin: "-40% 0px -40% 0px" // Activa cuando la sección está en el medio
            }); 

            navSections.forEach(section => {
                if(section) navObserver.observe(section);
            });
            
            // Animación "shake" para login (Animate.css)
            // No es necesario añadir CSS, ya usamos 'animate__shakeX' en JS
        }
        
        // --- Configuración de Listeners de UI ---
        function setupEventListeners() {
            window.addEventListener('hashchange', handleRouting);
            window.addEventListener('load', handleRouting);
            
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    document.getElementById('mobile-menu').classList.add('hidden');
                });
            });

            document.getElementById('mobile-menu-btn').addEventListener('click', () => {
                document.getElementById('mobile-menu').classList.toggle('hidden');
            });
            
            document.getElementById('filter-marca').addEventListener('change', renderCatalogo);
            document.getElementById('filter-precio').addEventListener('change', renderCatalogo);
            document.getElementById('filter-ano').addEventListener('change', renderCatalogo);
            document.getElementById('filter-sort').addEventListener('change', renderCatalogo);
            
            document.getElementById('detalle-auto-close-btn').addEventListener('click', closeDetalleAutoModal);
            
            document.getElementById('admin-login-form').addEventListener('submit', handleAdminLogin);
            document.getElementById('admin-logout-btn').addEventListener('click', handleAdminLogout);
            
            document.getElementById('admin-contact-form').addEventListener('submit', handleContactFormSubmit);
            
            document.getElementById('admin-add-car-btn').addEventListener('click', () => showCarFormModal());
            document.getElementById('car-form').addEventListener('submit', handleCarFormSubmit);
            document.getElementById('car-form-close-btn').addEventListener('click', closeCarFormModal);
            document.getElementById('car-form-cancel-btn').addEventListener('click', closeCarFormModal);

            document.getElementById('delete-modal-cancel-btn').addEventListener('click', closeDeleteModal);
            document.getElementById('delete-modal-confirm-btn').addEventListener('click', confirmDeleteCar);
        }

        // --- Iniciar la App ---
        // (NUEVO) Esperar a que el DOM esté listo (como sugeriste)
        window.addEventListener('DOMContentLoaded', () => {
            initializeMainApp();
        });

    </script>
</body>
</html>
